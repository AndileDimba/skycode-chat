<div class="flex flex-col h-screen" *ngIf="me(); else loading">
  <app-top-bar [displayName]="me()?.displayName || ''" (logout)="signOut()"></app-top-bar>
  <div class="chat-layout bg-whatsapp-gray">
  <app-side-nav></app-side-nav>
  <app-contact-list
    [contacts]="filteredUsers()"
    [selectedUid]="other()?.uid || null"
    [lastMessagePreview]="lastMessagePreview.bind(this)"
    [lastMessageTime]="lastMessageTime.bind(this)"
    [unreadCount]="unreadCount.bind(this)"
    [currentUserName]="me()?.displayName || ''"
    (signOut)="signOut()"
    (newChat)="openNewChat()"
    (contactSelected)="selectContact($event)"
  ></app-contact-list>


  <div class="chat-right bg-whatsapp-bg bg-whatsapp-pattern" *ngIf="other(); else selectContactView">
    
    <div class="chat-right-header bg-white border-b border-gray-200 p-3 flex items-center justify-between text-gray-800">
      <div class="flex items-center space-x-3">
        <div class="chat-avatar w-10 h-10 avatar-gradient rounded-full flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">
          {{ initials(other()?.displayName) }}
        </div>
        <div class="min-w-0 flex-1">
          <div class="chat-username font-semibold text-sm truncate">{{ other()?.displayName }}</div>
          <div class="chat-status text-xs opacity-90">Online</div>
        </div>
      </div>
      <div class="flex space-x-2 flex-shrink-0">
        <button class="header-btn p-2 text-white hover:bg-white/10 rounded-full transition-colors">
          ðŸ“ž
        </button>
        <button class="header-btn p-2 text-white hover:bg-white/10 rounded-full transition-colors">
          ðŸ“¹
        </button>
        <button class="header-btn p-2 text-white hover:bg-white/10 rounded-full transition-colors">
          â‹¯
        </button>
      </div>
    </div>

    <div class="chat-right-messages bg-white">
      <div *ngIf="errorMsg()" class="px-5 py-2 text-sm text-red-600">{{ errorMsg() }}</div>
      <app-message-list
        [messageGroups]="messageGroups()"
        [isOwn]="isOwnMessage.bind(this)"
        [formatTime]="formatMessageTime.bind(this)"
      ></app-message-list>
    </div>

    <div class="chat-right-input bg-white border-t border-gray-200 p-4">
      <div class="input-wrapper flex items-end space-x-2 mx-auto bg-white rounded-3xl p-3 shadow-sm">
        <button class="input-btn p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-100 transition-colors flex-shrink-0">
          ðŸ“Ž
        </button>
        <input
          [(ngModel)]="newMessage"
          type="text"
          class="message-input flex-1 border-none outline-none px-3 py-2 text-sm resize-none max-h-24 min-h-[20px] leading-relaxed"
          placeholder="Type a message..."
          (keydown.enter)="sendMessage($any($event))"
          (keyup)="autoResize($any($event))"
        />
        <button class="input-btn p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition-colors absolute right-3 top-1/2 transform -translate-y-1/2" *ngIf="showEmojiPicker">
          ðŸ˜Š
        </button>
        <button
          class="send-btn w-9 h-9 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center flex-shrink-0 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="sendMessage()"
          [disabled]="!newMessage"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
          </svg>
        </button>
      </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loading>
  <div class="min-h-screen bg-whatsapp-gray flex items-center justify-center">
    <div class="flex flex-col items-center space-y-4 text-gray-600">
      <div class="w-8 h-8 border-2 border-whatsapp-gray border-t-whatsapp-green rounded-full animate-spin-slow"></div>
      <div class="text-lg font-medium">Loading chat...</div>
    </div>
  </div>
</ng-template>

<ng-template #selectContactView>
  <div class="min-h-screen bg-whatsapp-bg bg-whatsapp-pattern flex items-center justify-center">
    <div class="flex flex-col items-center space-y-4 text-center text-gray-600">
      <div class="text-6xl">ðŸ’¬</div>
      <div class="text-xl font-medium">Select a contact to start messaging</div>
    </div>
  </div>
</ng-template>
